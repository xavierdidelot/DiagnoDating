---
title: "Simulation with no structure"
author: "Xavier Didelot"
date: '`r Sys.Date()`'
output:
  html_document: default
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Simulation with no structure}
  %\usepackage[utf8]{inputenc}
---

We start by generating a dated tree with no structure and a small effective population size 
$N_e g=1$ year relative to the sampling frame of 10 years between 2010 and 2020:

```{r}
library(DiagnoDating,quietly=T)
set.seed(0)
dates=runif(100,2010,2020)
dt=simcoaltree(dates,alpha=1)
plot(dt,show.tip.label = F)
axisPhylo(backward = F)
```

Next we generate a phylogenetic tree using a Poisson(10) mutation model:
```{r}
tree=simobsphy(dt,mu=10,model='poisson')
plot(tree,show.tip.label = F)
axisPhylo(1,backward=F)
```

A root-to-tip regression analysis works perfectly:

```{r}
res=roottotip(tree,dates)
```

The BactDating analysis also works perfectly:

```{r}
tree=unroot(tree)
r=runDating(tree,dates,algo='BactDating')
BactDating:::plot.resBactDating(r,'trace')
plot(r,show.tip.label=F)
print(r)
```

Analysis using LSD:
```{r}
r=runDating(unroot(tree),dates,algo='LSD')
plot(r,show.tip.label=F)
print(r)
```

Analysis using treedater:

```{r}
r=runDating(tree,dates,algo='treedater')
plot(r,show.tip.label=F)
print(r)
```

Analysis using node.dating:
```{r}
r=runDating(tree,dates,algo='node.dating')
plot(r,show.tip.label=F)
print(r)
```

There is strong association between genetic and temporal distances:

```{r}
tim=as.matrix(dist(dates))
gen=cophenetic.phylo(tree)
plot(tim[upper.tri(tim)],gen[upper.tri(gen)],xlab='Time distance',ylab='Genetic distance')
```

Mantel test from the vegan package:
```{r}
vegan::mantel(gen,tim)
```

Mantel test from the ape package:
```{r}
ape::mantel.test(gen,tim)
```

Mantel test from the ade4 package:
```{r}
ade4::mantel.rtest(as.dist(gen),as.dist(tim))
```

Kruskal-Wallis test of sampling dates imbalance:
```{r}
pvals=testImbalance(tree,dates)
min(p.adjust(pvals,"bonferroni"))
```
